<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>360Â° Depth-Pano Viewer</title>
  <style>
    /* ---------- layout ---------- */
    :root { --sidebar-w: 140px; }
    html,body{ margin:0; height:100%; overflow:hidden; }
    #sidebar{
      position:fixed; top:0; left:0; width:var(--sidebar-w); height:100%;
      background:#111; overflow-y:auto; padding:8px 4px; box-sizing:border-box;
      display:flex; flex-direction:column; gap:6px;
    }
    #sidebar img{
      width:100%; aspect-ratio:1/1; object-fit:cover;
      cursor:pointer; border:2px solid transparent; box-sizing:border-box;
      transition:border-color .15s;
    }
    #sidebar img.selected { border-color:#0af; }
    #blocker{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.5); color:#fff; font:18px sans-serif; cursor:pointer;
      z-index:5;
    }
    #c{ position:fixed; top:0; left:var(--sidebar-w); width:calc(100vw - var(--sidebar-w)); height:100%; display:block;}
  </style>
</head>
<body>
  <div id="sidebar"></div>
  <div id="blocker">Click to enter and lock pointer</div>
  <canvas id="c"></canvas>

  <!-- three.js & controls -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/controls/PointerLockControls.js"></script>

  <script>
  /* ---------- 1. CONFIG ---------- */
  const SCENES = [
    'achillies', 
    'arnolfini',
    'landscape',
    'mill',
  ];
  const BASE = 'test_folders';   // parent folder of each scene

  /* ---------- 2. THREE BOILERPLATE ---------- */
  const canvas   = document.getElementById('c');
  const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
  resize(); window.addEventListener('resize', resize);

  const scene  = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(75, canvas.clientWidth/canvas.clientHeight, 0.1, 2000);
  camera.position.set(0,0,0.1);

  const controls = new THREE.PointerLockControls(camera, document.body);
  scene.add(controls.getObject());
  const blocker = document.getElementById('blocker');
  blocker.addEventListener('click', ()=>controls.lock());
  controls.addEventListener('lock',  ()=>blocker.style.display='none');
  controls.addEventListener('unlock',()=>blocker.style.display='flex');

  /* ---------- 3. LIGHTS ---------- */
  scene.add(new THREE.DirectionalLight(0xffffff,1).position.set(0,1,0));
  scene.add(new THREE.HemisphereLight(0xffffff,0x444444,0.6));
  scene.add(new THREE.AmbientLight(0x888888));

  /* ---------- 4. GEOMETRY & MATERIAL ---------- */
  const geometry = new THREE.SphereBufferGeometry(500,200,100);
  geometry.scale(-1,1,1);                // inside-out
  const material = new THREE.MeshStandardMaterial({roughness:1});
  scene.add(new THREE.Mesh(geometry, material));

  /* ---------- 5. SCENE LOADING ---------- */
  const loader = new THREE.TextureLoader();
  function loadScene(name){
    const folder = `${BASE}/${name}`;
    const colorPath = `${folder}/fixed_pano.jpg`;
    const depthPath = `${folder}/depth_pano.jpg`;

    // dispose previous textures to free GPU RAM
    if(material.map)            material.map.dispose();
    if(material.displacementMap)material.displacementMap.dispose();

    loader.load(colorPath, tex=>{
      tex.minFilter = tex.magFilter = THREE.LinearFilter;
      material.map = tex;
      material.needsUpdate = true;
    });
    loader.load(depthPath, tex=>{
      tex.minFilter = tex.magFilter = THREE.LinearFilter;
      tex.wrapS = tex.wrapT = THREE.ClampToEdgeWrapping;
      material.displacementMap   = tex;
      material.displacementScale = 200;
      material.displacementBias  = -50;
      material.needsUpdate = true;
    });

    /* UI highlight */
    document.querySelectorAll('#sidebar img').forEach(img=>img.classList.toggle(
      'selected', img.dataset.name===name
    ));
  }

  /* ---------- 6. BUILD SIDEBAR THUMBNAILS ---------- */
  const sidebar = document.getElementById('sidebar');
  SCENES.forEach(name=>{
    const thumb = document.createElement('img');
    thumb.dataset.name = name;
    thumb.src = `${BASE}/${name}/input.jpg`;
    thumb.title = name;
    thumb.addEventListener('click', ()=>loadScene(name));
    sidebar.appendChild(thumb);
  });

  // load first scene by default
  loadScene(SCENES[0]);

  /* ---------- 7. MOVEMENT ---------- */
  const key = {w:0,a:0,s:0,d:0};
  window.addEventListener('keydown',e=>{
    if(e.code==='KeyW'||e.code==='ArrowUp')   key.w=1;
    if(e.code==='KeyS'||e.code==='ArrowDown') key.s=1;
    if(e.code==='KeyA'||e.code==='ArrowLeft') key.a=1;
    if(e.code==='KeyD'||e.code==='ArrowRight')key.d=1;
  });
  window.addEventListener('keyup',e=>{
    if(e.code==='KeyW'||e.code==='ArrowUp')   key.w=0;
    if(e.code==='KeyS'||e.code==='ArrowDown') key.s=0;
    if(e.code==='KeyA'||e.code==='ArrowLeft') key.a=0;
    if(e.code==='KeyD'||e.code==='ArrowRight')key.d=0;
  });

  let prev = performance.now();
  (function animate(now){
    requestAnimationFrame(animate);
    const dt=(now-prev)/1000; prev=now;
    const speed=50;
    if(controls.isLocked){
      if(key.w)controls.moveForward( speed*dt);
      if(key.s)controls.moveForward(-speed*dt);
      if(key.a)controls.moveRight  (-speed*dt);
      if(key.d)controls.moveRight  ( speed*dt);
    }
    renderer.render(scene,camera);
  })(performance.now());

  /* ---------- util ---------- */
  function resize(){
    const w=window.innerWidth-parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sidebar-w'));
    const h=window.innerHeight;
    renderer.setSize(w,h);
    camera.aspect=w/h;
    camera.updateProjectionMatrix();
  }
  </script>
</body>
</html>
